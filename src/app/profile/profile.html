<div class="profile-container">
  <div class="container">
    <h1>Your Account</h1>

    @if (!isAuthenticated()) {
      <div class="not-authenticated">
        <h2>Please sign in to view your account</h2>
        <p>You need to be logged in to access your profile information.</p>
      </div>
    } @else {
      <div class="profile-content">
        @if (loading()) {
          <div class="loading-section">
            <p>Loading customer data...</p>
          </div>
        } @else if (error()) {
          <div class="error-section">
            <p>{{ error() }}</p>
            <button (click)="loadCustomer(userData()?.email || '')">Retry</button>
          </div>
        } @else if (success()) {
          <div class="success-section">
            <p>{{ success() }}</p>
          </div>
        } @else if (customer(); as cust) {
          <div class="profile-section">
            <h2>Profile Information</h2>
            <form (ngSubmit)="saveProfile()" #profileForm="ngForm">
              <div class="form-grid">
                <div class="form-group">
                  <label for="firstName">First Name:</label>
                  <input id="firstName" name="firstName" [(ngModel)]="cust.first_name" required>
                </div>
                <div class="form-group">
                  <label for="lastName">Last Name:</label>
                  <input id="lastName" name="lastName" [(ngModel)]="cust.last_name" required>
                </div>
                <div class="form-group">
                  <label for="phone">Phone:</label>
                  <input id="phone" name="phone" [(ngModel)]="cust.phone">
                </div>
                <div class="form-group">
                  <label for="email">Email:</label>
                  <input id="email" name="email" [(ngModel)]="cust.email" readonly>
                </div>
              </div>
              <button type="submit" class="save-button" [disabled]="!profileForm.valid || loading()">Save Profile</button>
            </form>
          </div>

          <div class="profile-section">
            <h2>Addresses</h2>
            @if (cust.addresses && cust.addresses.length > 0) {
              @for (address of cust.addresses; track address; let i = $index) {
                <div class="address-item">
                  <div class="address-details">
                    <p><strong>{{ address?.first_name }} {{ address?.last_name }}</strong></p>
                    <p>{{ address?.address_1 }} @if (address?.address_2) { {{ address?.address_2 }} }</p>
                    <p>{{ address?.city }}, {{ address?.state }} {{ address?.zip }}</p>
                    <p><em>{{ address?.address_type }} @if (address?.is_default) { (Default) }</em></p>
                  </div>
                  <div class="address-actions">
                    <button class="action-button danger" (click)="deleteAddress(i)">Delete</button>
                    @if (!address?.is_default) {
                      <button class="action-button" (click)="setDefaultAddress(i)">Set as Default</button>
                    }
                  </div>
                </div>
              }
            } @else {
              <p>No addresses saved yet.</p>
            }
            <button class="add-button" (click)="addNewAddress()">Add Address</button>
          </div>

          <div class="profile-section">
            <h2>Credit Cards</h2>
            @if (cust.credit_cards && cust.credit_cards.length > 0) {
              @for (card of cust.credit_cards; track card; let i = $index) {
                <div class="card-item">
                  <div class="card-details">
                    <p><strong>{{ card?.card_holder_name }}</strong></p>
                    <p>{{ maskCardNumber(card?.card_number) }}</p>
                    <p>Expires: {{ card?.card_expires }}</p>
                    <p><em>{{ card?.card_type }} @if (card?.is_default) { (Default) }</em></p>
                  </div>
                  <div class="card-actions">
                    <button class="action-button danger" (click)="deleteCard(i)">Delete</button>
                    @if (!card?.is_default) {
                      <button class="action-button" (click)="setDefaultCard(i)">Set as Default</button>
                    }
                  </div>
                </div>
              }
            } @else {
              <p>No credit cards saved yet.</p>
            }
            <button class="add-button" (click)="addNewCard()">Add Credit Card</button>
          </div>
        } @else {
          <div class="no-data">
            <p>Unable to load customer data.</p>
          </div>
        }

        <!-- Add Address Modal -->
        <app-modal [isOpen]="addingAddress()" title="Add New Address" (close)="cancelAddAddress()">
          <form (ngSubmit)="saveNewAddress({
            address_type: newAddressType,
            first_name: newAddressFirstName,
            last_name: newAddressLastName,
            address_1: newAddress1,
            address_2: newAddress2,
            city: newAddressCity,
            state: newAddressState,
            zip: newAddressZip,
            is_default: false
          })">
            <div class="form-row">
              <div class="form-group">
                <label for="newAddrType">Type:</label>
                <select id="newAddrType" name="newAddrType" [(ngModel)]="newAddressType" required>
                  <option value="shipping">Shipping</option>
                  <option value="billing">Billing</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newFirstName">First Name:</label>
                <input id="newFirstName" name="newFirstName" [(ngModel)]="newAddressFirstName" required>
              </div>
              <div class="form-group">
                <label for="newLastName">Last Name:</label>
                <input id="newLastName" name="newLastName" [(ngModel)]="newAddressLastName" required>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="newAddress1">Address Line 1:</label>
                <input id="newAddress1" name="newAddress1" [(ngModel)]="newAddress1" required>
              </div>
              <div class="form-group">
                <label for="newAddress2">Address Line 2:</label>
                <input id="newAddress2" name="newAddress2" [(ngModel)]="newAddress2">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="newCity">City:</label>
                <input id="newCity" name="newCity" [(ngModel)]="newAddressCity" required>
              </div>
              <div class="form-group">
                <label for="newState">State:</label>
                <input id="newState" name="newState" [(ngModel)]="newAddressState" required>
              </div>
              <div class="form-group">
                <label for="newZip">ZIP:</label>
                <input id="newZip" name="newZip" [(ngModel)]="newAddressZip" required>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="save-button" [disabled]="loading()">Add Address</button>
              <button type="button" class="cancel-button" (click)="cancelAddAddress()">Cancel</button>
            </div>
          </form>
        </app-modal>

        <!-- Add Credit Card Modal -->
        <app-modal [isOpen]="addingCard()" title="Add New Credit Card" (close)="cancelAddCard()">
          <form (ngSubmit)="saveNewCard({
            card_type: newCardType,
            card_number: newCardNumber,
            card_holder_name: newCardHolderName,
            card_expires: newCardExpires,
            card_cvv: newCardCvv,
            is_default: false
          })">
            <div class="form-row">
              <div class="form-group">
                <label for="newCardType">Card Type:</label>
                <select id="newCardType" name="newCardType" [(ngModel)]="newCardType" required>
                  <option value="visa">Visa</option>
                  <option value="mastercard">MasterCard</option>
                  <option value="amex">American Express</option>
                  <option value="discover">Discover</option>
                </select>
              </div>
              <div class="form-group">
                <label for="newCardNumber">Card Number:</label>
                <input id="newCardNumber" name="newCardNumber" [(ngModel)]="newCardNumber" required placeholder="Enter full card number">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="newCardHolder">Card Holder Name:</label>
                <input id="newCardHolder" name="newCardHolder" [(ngModel)]="newCardHolderName" required>
              </div>
              <div class="form-group">
                <label for="newCardExpires">Expiration (MM/YY):</label>
                <input id="newCardExpires" name="newCardExpires" [(ngModel)]="newCardExpires" required placeholder="MM/YY">
              </div>
              <div class="form-group">
                <label for="newCardCvv">CVV:</label>
                <input id="newCardCvv" name="newCardCvv" type="password" [(ngModel)]="newCardCvv" required placeholder="CVV">
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="save-button" [disabled]="loading()">Add Credit Card</button>
              <button type="button" class="cancel-button" (click)="cancelAddCard()">Cancel</button>
            </div>
          </form>
        </app-modal>
      </div>
    }
  </div>
</div>
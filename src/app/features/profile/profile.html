<div class="profile-container">
  <div class="container">
    <h1>Your Account</h1>

    @if (!isAuthenticated()) {
      <div class="not-authenticated">
        <h2>Please sign in to view your account</h2>
        <p>You need to be logged in to access your profile information.</p>
      </div>
    } @else {
      <div class="profile-content">
        @if (loading()) {
          <div class="loading-section">
            <p>Loading customer data...</p>
          </div>
        } @else if (error()) {
          <div class="error-section">
            <p>{{ error() }}</p>
            <button (click)="clearError()">Retry</button>
          </div>
        } @else if (customer(); as cust) {
          <!-- Profile Information Section -->
          <div class="profile-section">
            <h2>Profile Information</h2>
            <form [formGroup]="customerForm()" (ngSubmit)="saveProfile()">
    <div class="form-grid" [style]="'gap: 1.5rem !important;'">
                <div class="form-group">
                  <label for="firstName">First Name:</label>
                  <input id="firstName" formControlName="first_name" />
                  @if (getErrorMessage('first_name')) {
                    <small class="error">{{ getErrorMessage('first_name') }}</small>
                  }
                </div>
                <div class="form-group">
                  <label for="lastName">Last Name:</label>
                  <input id="lastName" formControlName="last_name" />
                  @if (getErrorMessage('last_name')) {
                    <small class="error">{{ getErrorMessage('last_name') }}</small>
                  }
                </div>
                <div class="form-group">
                  <label for="phone">Phone:</label>
                  <input id="phone" formControlName="phone" />
                  @if (getErrorMessage('phone')) {
                    <small class="error">{{ getErrorMessage('phone') }}</small>
                  }
                </div>
                <div class="form-group">
                  <label for="email">Email:</label>
                  <input id="email" formControlName="email" readonly />
                </div>
              </div>
              <div class="form-actions">
                @if (!editingProfile()) {
                  <button type="button" class="edit-button" (click)="editingProfile.set(true)">Edit Profile</button>
                } @else {
                  <button type="submit" class="save-button" [disabled]="customerForm().invalid">Save Profile</button>
                  <button type="button" class="cancel-button" (click)="editingProfile.set(false)">Cancel</button>
                }
              </div>
            </form>
          </div>

          <!-- Addresses Section -->
          <div class="addresses-section">
            <h2>Addresses</h2>
            <div class="section-actions">
              <button class="add-button" (click)="openAddressModal()">Add Address</button>
            </div>
            
            @for (address of addresses(); track address.address_id) {
              <div class="address-card">
                <div class="address-info">
                  <h3>{{ address.address_type }}</h3>
                  <p>{{ address.first_name }} {{ address.last_name }}</p>
                  <p>{{ address.address_1 }}</p>
                  @if (address.address_2) {
                    <p>{{ address.address_2 }}</p>
                  }
                  <p>{{ address.city }}, {{ address.state }} {{ address.zip }}</p>
                  @if (address.is_default) {
                    <span class="default-badge">Default</span>
                  }
                </div>
                <div class="address-actions">
                  <button class="edit-button" (click)="openAddressModal(address.address_id!)">Edit</button>
                  <button class="delete-button" (click)="deleteAddress(address.address_id!)">Delete</button>
                </div>
              </div>
            }
          </div>

          <!-- Credit Cards Section -->
          <div class="cards-section">
            <h2>Credit Cards</h2>
            <div class="section-actions">
              <button class="add-button" (click)="openCreditCardModal()">Add Credit Card</button>
            </div>
            
            @for (card of creditCards(); track card.card_id) {
              <div class="card-card">
                <div class="card-info">
                  <h3>{{ card.card_type }}</h3>
                  <p>{{ maskCardNumber(card.card_number) }}</p>
                  <p>{{ card.card_holder_name }}</p>
                  <p>Expires: {{ card.card_expires }}</p>
                  @if (card.is_default) {
                    <span class="default-badge">Default</span>
                  }
                </div>
                <div class="card-actions">
                  <button class="edit-button" (click)="openCreditCardModal(card.card_id!)">Edit</button>
                  <button class="delete-button" (click)="deleteCreditCard(card.card_id!)">Delete</button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    }
  </div>
</div>

 <!-- Address Modal -->
<app-modal 
  [isOpen]="addressModalOpen()" 
  [title]="getAddressModalTitle()" 
  (close)="closeAddressModal()">
  <form [formGroup]="addressForm()" (ngSubmit)="saveAddress()">
    <div class="form-grid" [style]="'gap: 1.5rem !important;'">
      <div class="form-group">
        <label for="addressType" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Address Type:</label>
        <select id="addressType" formControlName="address_type" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'">
          <option value="shipping">Shipping</option>
          <option value="billing">Billing</option>
        </select>
        @if (getAddressErrorMessage('address_type')) {
          <small class="error">{{ getAddressErrorMessage('address_type') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="first_name" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">First Name:</label>
        <input id="first_name" formControlName="first_name" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('first_name')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('first_name') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="last_name" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Last Name:</label>
        <input id="last_name" formControlName="last_name" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('last_name')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('last_name') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="address1" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Address Line 1:</label>
        <input id="address1" formControlName="address_1" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('address_1')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('address_1') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="address2" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Address Line 2:</label>
        <input id="address2" formControlName="address_2" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('address_2')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('address_2') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="city" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">City:</label>
        <input id="city" formControlName="city" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('city')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('city') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="state" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">State:</label>
        <input id="state" formControlName="state" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('state')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('state') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="zip" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">ZIP Code:</label>
        <input id="zip" formControlName="zip" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getAddressErrorMessage('zip')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getAddressErrorMessage('zip') }}</small>
        }
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="is_default" />
          Set as default address
        </label>
      </div>
    </div>
    <div class="form-actions">
      <button type="submit" class="save-button" [disabled]="!addressFormState().canSave" [class.active]="addressFormState().canSave" [style]="addressFormState().canSave ? 'background-color: #28a745 !important; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4) !important; border: 1px solid #218838 !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important; cursor: pointer !important;' : 'background-color: #cccccc !important; color: #666666 !important; cursor: not-allowed !important; opacity: 0.6 !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important;'">{{ editingAddressId() ? 'Update Address' : 'Add Address' }}</button>
      <button type="button" class="cancel-button" (click)="closeAddressModal()" [style]="addressFormState().canSave ? 'background-color: #c5c8cc !important; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; border: 1px solid #a8acb8 !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important; margin-left: 1rem !important;' : 'background-color: #e7e9ec !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important; margin-left: 1rem !important;'">Cancel</button>
    </div>
  </form>
</app-modal>

<!-- Credit Card Modal -->
<app-modal 
  [isOpen]="creditCardModalOpen()" 
  [title]="getCreditCardModalTitle()" 
  (close)="closeCreditCardModal()">
  <form [formGroup]="creditCardForm()" (ngSubmit)="saveCreditCard()">
    <div class="form-grid" [style]="'gap: 1.5rem !important;'">
      <div class="form-group">
        <label for="cardType" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Card Type:</label>
        <select id="cardType" formControlName="card_type" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'">
          <option value="visa">Visa</option>
          <option value="mastercard">Mastercard</option>
          <option value="amex">American Express</option>
          <option value="discover">Discover</option>
        </select>
        @if (getCardErrorMessage('card_type')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getCardErrorMessage('card_type') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="cardNumber" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Card Number:</label>
        <input id="cardNumber" formControlName="card_number" (input)="onCardNumberInput($event)" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getCardErrorMessage('card_number')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getCardErrorMessage('card_number') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="cardHolderName" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Cardholder Name:</label>
        <input id="cardHolderName" formControlName="card_holder_name" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important;'" />
        @if (getCardErrorMessage('card_holder_name')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getCardErrorMessage('card_holder_name') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="cardExpires" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">Expiration Date (MM/YY):</label>
        <input id="cardExpires" formControlName="card_expires" placeholder="MM/YY" (input)="onCardExpirationInput($event)" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important; width: 100px !important;'" />
        @if (getCardErrorMessage('card_expires')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getCardErrorMessage('card_expires') }}</small>
        }
      </div>
      <div class="form-group">
        <label for="cardCVV" [style]="'font-size: var(--label-font-size) !important; font-family: var(--base-font-family) !important; margin-right: 1rem !important; display: inline-block !important; width: 120px !important;'">CVV:</label>
        <input id="cardCVV" formControlName="card_cvv" [style]="'font-size: var(--input-font-size) !important; font-family: var(--base-font-family) !important; margin-bottom: 0.25rem !important; display: inline-block !important; width: 80px !important;'" />
        @if (getCardErrorMessage('card_cvv')) {
          <small class="error" [style]="'margin-left: 1rem !important; display: inline-block !important; font-size: var(--error-font-size) !important; font-family: var(--base-font-family) !important; color: #c40000 !important;'">{{ getCardErrorMessage('card_cvv') }}</small>
        }
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" formControlName="is_default" />
          Set as default card
        </label>
      </div>
    </div>
    <div class="form-actions">
      <button type="submit" class="save-button" [disabled]="!creditCardFormState().canSave" [class.active]="creditCardFormState().canSave" [style]="creditCardFormState().canSave ? 'background-color: #28a745 !important; box-shadow: 0 4px 8px rgba(40, 167, 69, 0.4) !important; border: 1px solid #218838 !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important; cursor: pointer !important;' : 'background-color: #cccccc !important; color: #666666 !important; cursor: not-allowed !important; opacity: 0.6 !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important;'">{{ editingCardId() ? 'Update Credit Card' : 'Add Credit Card' }}</button>
      <button type="button" class="cancel-button" (click)="closeCreditCardModal()" [style]="creditCardFormState().canSave ? 'background-color: #c5c8cc !important; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2) !important; border: 1px solid #a8acb8 !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important; margin-left: 1rem !important;' : 'background-color: #e7e9ec !important; font-size: var(--button-font-size) !important; font-family: var(--base-font-family) !important; margin-left: 1rem !important;'">Cancel</button>
    </div>
  </form>
</app-modal>